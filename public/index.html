<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>LAN Video Server</title>
    <script src="https://unpkg.com/lucide@0.294.0/dist/umd/lucide.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --sp-3: 3px;
        --sp-5: 5px;
        --sp-8: 8px;
        --sp-13: 13px;
        --sp-21: 21px;
        --sp-34: 34px;
        --sp-55: 55px;
        --sp-89: 89px;
        --black: #0a0a0a;
        --white: #fafafa;
        --gray-100: #f5f5f5;
        --gray-200: #e5e5e5;
        --gray-300: #d4d4d4;
        --gray-400: #a3a3a3;
        --gray-500: #737373;
        --gray-600: #525252;
        --gray-700: #404040;
        --gray-800: #262626;
        --gray-900: #171717;
        --accent: #ff3b30;
        --accent-hover: #ff453a;
        --success: #30d158;
        --text-xs: 11px;
        --text-sm: 13px;
        --text-base: 16px;
        --text-lg: 21px;
        --text-2xl: 34px;
      }
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family:
          "Inter",
          -apple-system,
          sans-serif;
        background: var(--black);
        color: var(--white);
        min-height: 100vh;
        line-height: 1.618;
        -webkit-font-smoothing: antialiased;
      }
      .container {
        max-width: 987px;
        margin: 0 auto;
        padding: var(--sp-34) var(--sp-21);
      }

      /* Header */
      .header {
        display: flex;
        align-items: center;
        gap: var(--sp-21);
        margin-bottom: var(--sp-55);
        padding-bottom: var(--sp-21);
        border-bottom: 1px solid var(--gray-800);
      }
      .logo {
        width: var(--sp-55);
        height: var(--sp-55);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--accent);
      }
      .logo i {
        width: var(--sp-34);
        height: var(--sp-34);
        color: var(--white);
      }
      .header-text h1 {
        font-size: var(--text-2xl);
        font-weight: 600;
        letter-spacing: -0.02em;
      }
      .header-text p {
        font-size: var(--text-sm);
        color: var(--gray-400);
      }

      /* Main input area */
      .main-input {
        position: relative;
        margin-bottom: var(--sp-21);
      }
      .main-input input {
        width: 100%;
        padding: var(--sp-21) var(--sp-21) var(--sp-21) var(--sp-55);
        font-size: var(--text-lg);
        font-family: inherit;
        background: var(--gray-900);
        border: 2px solid var(--gray-700);
        color: var(--white);
        transition: all 0.2s;
      }
      .main-input input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .main-input input::placeholder {
        color: var(--gray-600);
      }
      .main-input .input-icon {
        position: absolute;
        left: var(--sp-21);
        top: 50%;
        transform: translateY(-50%);
        color: var(--gray-500);
      }
      .main-input .input-icon i {
        width: var(--sp-21);
        height: var(--sp-21);
      }

      /* Detection hint */
      .detect-hint {
        display: flex;
        align-items: center;
        gap: var(--sp-8);
        padding: var(--sp-8) var(--sp-13);
        background: var(--gray-800);
        font-size: var(--text-sm);
        color: var(--gray-400);
        margin-bottom: var(--sp-21);
        min-height: 36px;
      }
      .detect-hint i {
        width: 16px;
        height: 16px;
      }
      .detect-hint.ready {
        color: var(--success);
      }
      .detect-hint .site-badge {
        background: var(--gray-700);
        padding: 2px 8px;
        font-size: var(--text-xs);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }

      /* Action button */
      .send-btn {
        width: 100%;
        padding: var(--sp-21);
        font-size: var(--text-base);
        font-weight: 600;
        font-family: inherit;
        background: var(--accent);
        color: var(--white);
        border: none;
        cursor: pointer;
        transition: background 0.15s;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--sp-8);
      }
      .send-btn:hover {
        background: var(--accent-hover);
      }
      .send-btn:disabled {
        background: var(--gray-700);
        cursor: not-allowed;
      }
      .send-btn i {
        width: var(--sp-21);
        height: var(--sp-21);
      }

      /* Secondary actions */
      .secondary-actions {
        display: flex;
        gap: var(--sp-8);
        margin-top: var(--sp-13);
      }
      .sec-btn {
        flex: 1;
        padding: var(--sp-13);
        font-size: var(--text-sm);
        font-family: inherit;
        background: transparent;
        color: var(--gray-400);
        border: 1px solid var(--gray-700);
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--sp-5);
      }
      .sec-btn:hover {
        color: var(--white);
        border-color: var(--white);
      }
      .sec-btn i {
        width: 14px;
        height: 14px;
      }

      /* Remote Control */
      .remote-control {
        margin-top: var(--sp-21);
        padding: var(--sp-21);
        background: var(--gray-900);
        border: 1px solid var(--gray-800);
      }
      .remote-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--sp-13);
      }
      .remote-title {
        font-size: var(--text-xs);
        color: var(--gray-500);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .remote-media {
        font-size: var(--text-sm);
        color: var(--gray-300);
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
      .remote-progress {
        display: flex;
        align-items: center;
        gap: var(--sp-13);
        margin-bottom: var(--sp-13);
      }
      .remote-time {
        font-size: var(--text-xs);
        color: var(--gray-400);
        font-variant-numeric: tabular-nums;
        min-width: 45px;
      }
      .remote-seek {
        flex: 1;
        height: 6px;
        background: var(--gray-700);
        cursor: pointer;
        position: relative;
      }
      .remote-seek-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        background: var(--accent);
        width: 0%;
        transition: width 0.1s;
      }
      .remote-seek:hover .remote-seek-fill {
        background: var(--white);
      }
      .remote-buttons {
        display: flex;
        gap: var(--sp-8);
        justify-content: center;
      }
      .remote-btn {
        padding: var(--sp-13) var(--sp-21);
        font-size: var(--text-sm);
        font-family: inherit;
        background: var(--gray-800);
        color: var(--gray-300);
        border: 1px solid var(--gray-700);
        cursor: pointer;
        transition: all 0.15s;
        display: flex;
        align-items: center;
        gap: var(--sp-5);
      }
      .remote-btn:hover {
        color: var(--white);
        background: var(--gray-700);
        border-color: var(--gray-600);
      }
      .remote-btn:active {
        background: var(--accent);
        border-color: var(--accent);
      }
      .remote-btn i {
        width: 16px;
        height: 16px;
      }
      .remote-play {
        padding: var(--sp-13) var(--sp-34);
        background: var(--accent);
        border-color: var(--accent);
        color: var(--black);
      }
      .remote-play:hover {
        background: var(--white);
        border-color: var(--white);
      }

      /* TV status card */
      .tv-card {
        display: flex;
        align-items: center;
        gap: var(--sp-21);
        padding: var(--sp-21);
        background: var(--gray-900);
        border: 1px solid var(--gray-800);
        margin-bottom: var(--sp-34);
      }
      .tv-icon {
        width: var(--sp-55);
        height: var(--sp-55);
        display: flex;
        align-items: center;
        justify-content: center;
        background: var(--gray-800);
      }
      .tv-icon i {
        width: var(--sp-21);
        height: var(--sp-21);
      }
      .tv-info {
        flex: 1;
      }
      .tv-info h3 {
        font-size: var(--text-base);
        font-weight: 500;
        margin-bottom: 2px;
      }
      .tv-info p {
        font-size: var(--text-sm);
        color: var(--gray-400);
      }
      .tv-info a {
        color: var(--white);
        text-decoration: underline;
        text-underline-offset: 3px;
      }
      .tv-count {
        font-size: var(--text-2xl);
        font-weight: 600;
        color: var(--success);
      }
      .tv-count.zero {
        color: var(--gray-600);
      }

      /* History */
      .history {
        margin-top: var(--sp-55);
      }
      .history-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--sp-13);
      }
      .history-title {
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--gray-400);
      }
      .history-clear {
        font-size: var(--text-xs);
        color: var(--gray-600);
        background: none;
        border: none;
        cursor: pointer;
      }
      .history-clear:hover {
        color: var(--white);
      }
      .history-list {
        display: flex;
        flex-direction: column;
        gap: var(--sp-3);
      }
      .history-item {
        display: flex;
        align-items: center;
        gap: var(--sp-13);
        padding: var(--sp-13);
        background: var(--gray-900);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.15s;
      }
      .history-item:hover {
        border-color: var(--gray-700);
      }
      .history-item i {
        width: 16px;
        height: 16px;
        color: var(--gray-500);
        flex-shrink: 0;
      }
      .history-item .title {
        flex: 1;
        font-size: var(--text-sm);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }
      .history-item .site {
        font-size: var(--text-xs);
        color: var(--gray-600);
        text-transform: uppercase;
      }
      .history-item .delete {
        opacity: 0;
        color: var(--gray-600);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
      }
      .history-item:hover .delete {
        opacity: 1;
      }
      .history-item .delete:hover {
        color: var(--accent);
      }

      /* Preview */
      .preview {
        margin-top: var(--sp-34);
      }
      .preview-title {
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--gray-400);
        margin-bottom: var(--sp-13);
      }
      .preview-container {
        aspect-ratio: 16/9;
        background: var(--gray-900);
        border: 1px solid var(--gray-800);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
      }
      .preview-container video,
      .preview-container iframe,
      .preview-container img {
        width: 100%;
        height: 100%;
        object-fit: contain;
      }
      .preview-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: var(--sp-8);
        color: var(--gray-600);
      }
      .preview-placeholder i {
        width: var(--sp-34);
        height: var(--sp-34);
      }

      /* Status */
      .status {
        margin-top: var(--sp-13);
        padding: var(--sp-13);
        background: var(--gray-900);
        border-left: 2px solid var(--gray-700);
        font-size: var(--text-sm);
        color: var(--gray-400);
      }
      .status.success {
        border-color: var(--success);
      }
      .status.error {
        border-color: var(--accent);
      }

      /* Drop zone */
      .drop-zone {
        position: fixed;
        inset: 0;
        background: rgba(10, 10, 10, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }
      .drop-zone.active {
        display: flex;
      }
      .drop-zone-inner {
        border: 2px dashed var(--gray-600);
        padding: var(--sp-89);
        text-align: center;
      }
      .drop-zone-inner i {
        width: var(--sp-55);
        height: var(--sp-55);
        color: var(--gray-400);
        margin-bottom: var(--sp-21);
      }
      .drop-zone-inner p {
        font-size: var(--text-lg);
        color: var(--gray-400);
      }

      /* Search modal */
      .modal {
        position: fixed;
        inset: 0;
        background: rgba(10, 10, 10, 0.95);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        padding: var(--sp-21);
      }
      .modal.active {
        display: flex;
      }
      .modal-content {
        background: var(--gray-900);
        border: 1px solid var(--gray-700);
        max-width: 987px;
        width: 100%;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        padding: var(--sp-21);
        border-bottom: 1px solid var(--gray-800);
        display: flex;
        align-items: center;
        gap: var(--sp-13);
      }
      .modal-header input {
        flex: 1;
        padding: var(--sp-13);
        background: var(--gray-800);
        border: 1px solid var(--gray-700);
        color: var(--white);
        font-family: inherit;
        font-size: var(--text-base);
      }
      .modal-header input:focus {
        outline: none;
        border-color: var(--accent);
      }
      .modal-header .close-btn {
        width: var(--sp-34);
        height: var(--sp-34);
        display: flex;
        align-items: center;
        justify-content: center;
        background: transparent;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
      }
      .modal-header .close-btn:hover {
        color: var(--white);
      }
      .modal-tabs {
        display: flex;
        padding: var(--sp-8);
        gap: var(--sp-3);
        border-bottom: 1px solid var(--gray-800);
      }
      .modal-tab {
        padding: var(--sp-8) var(--sp-13);
        background: transparent;
        border: none;
        color: var(--gray-400);
        cursor: pointer;
        font-family: inherit;
        font-size: var(--text-sm);
        text-transform: uppercase;
        letter-spacing: 0.05em;
      }
      .modal-tab.active {
        color: var(--white);
        background: var(--gray-800);
      }
      .modal-body {
        flex: 1;
        overflow-y: auto;
        padding: var(--sp-13);
      }
      .search-results {
        display: flex;
        flex-direction: column;
        gap: var(--sp-8);
      }
      .search-result {
        display: flex;
        gap: var(--sp-13);
        padding: var(--sp-13);
        background: var(--gray-800);
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.15s;
      }
      .search-result:hover {
        border-color: var(--gray-600);
      }
      .search-result-thumb {
        width: 144px;
        height: 81px;
        background: var(--gray-700);
        flex-shrink: 0;
        overflow: hidden;
      }
      .search-result-thumb img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .search-result-info {
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: var(--sp-5);
      }
      .search-result-title {
        font-size: var(--text-base);
        font-weight: 500;
        line-height: 1.3;
      }
      .search-result-meta {
        font-size: var(--text-sm);
        color: var(--gray-400);
      }
      .search-loading {
        text-align: center;
        padding: var(--sp-34);
        color: var(--gray-400);
      }
      .search-empty {
        text-align: center;
        padding: var(--sp-34);
        color: var(--gray-600);
      }

      /* Bookmarklet */
      .bookmarklet {
        margin-top: var(--sp-34);
        padding: var(--sp-21);
        background: var(--gray-900);
        border: 1px solid var(--gray-800);
      }
      .bookmarklet-title {
        font-size: var(--text-xs);
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--gray-400);
        margin-bottom: var(--sp-8);
      }
      .bookmarklet-link {
        display: inline-block;
        padding: var(--sp-8) var(--sp-13);
        background: var(--gray-800);
        color: var(--white);
        text-decoration: none;
        font-size: var(--text-sm);
        border: 1px dashed var(--gray-600);
      }
      .bookmarklet-hint {
        font-size: var(--text-xs);
        color: var(--gray-600);
        margin-top: var(--sp-8);
      }

      /* Footer */
      .footer {
        margin-top: var(--sp-89);
        padding-top: var(--sp-21);
        border-top: 1px solid var(--gray-800);
        display: flex;
        justify-content: space-between;
        font-size: var(--text-xs);
        color: var(--gray-600);
      }

      @media (max-width: 610px) {
        .tv-card {
          flex-direction: column;
          text-align: center;
        }
        .secondary-actions {
          flex-wrap: wrap;
        }
      }
    </style>
  </head>
  <body>
    <div class="drop-zone" id="dropZone">
      <div class="drop-zone-inner">
        <i data-lucide="download"></i>
        <p>Drop .torrent file here</p>
      </div>
    </div>

    <!-- Search Modal -->
    <div class="modal" id="searchModal">
      <div class="modal-content">
        <div class="modal-header">
          <input
            type="text"
            id="searchInput"
            placeholder="–®—É–∫–∞—Ç–∏ –≤—ñ–¥–µ–æ..."
            autocomplete="off"
          />
          <button class="close-btn" id="closeSearch">
            <i data-lucide="x"></i>
          </button>
        </div>
        <div class="modal-tabs">
          <button class="modal-tab active" data-source="youtube">
            YouTube
          </button>
          <button class="modal-tab" data-source="torrents">Torrents</button>
        </div>
        <div class="modal-body">
          <div id="searchResultsContainer">
            <div class="search-empty">–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É</div>
          </div>
        </div>
      </div>
    </div>

    <div class="container">
      <header class="header">
        <div class="logo"><i data-lucide="play"></i></div>
        <div class="header-text">
          <h1>LAN Video</h1>
          <p>Any URL ‚Üí TV</p>
        </div>
      </header>

      <!-- TV Status -->
      <div class="tv-card">
        <div class="tv-icon"><i data-lucide="tv"></i></div>
        <div class="tv-info">
          <h3>Television</h3>
          <p>Open <a href="/tv.html" id="tvLink">/tv.html</a> on your TV</p>
        </div>
        <div class="tv-count zero" id="tvCount">0</div>
      </div>

      <!-- Main Input -->
      <div class="main-input">
        <span class="input-icon"
          ><i data-lucide="link" id="inputIcon"></i
        ></span>
        <input
          type="text"
          id="url"
          placeholder="Paste any URL ‚Äî YouTube, TikTok, torrent, video..."
          autocomplete="off"
        />
      </div>

      <!-- Detection hint -->
      <div class="detect-hint" id="detectHint">
        <i data-lucide="info"></i>
        <span id="detectText">Paste a URL to detect type</span>
      </div>

      <!-- Send button -->
      <button class="send-btn" id="sendBtn" disabled>
        <i data-lucide="send"></i>
        <span>Send to TV</span>
      </button>

      <!-- Secondary actions -->
      <div class="secondary-actions">
        <button class="sec-btn" id="searchBtn">
          <i data-lucide="search"></i> –ü–æ—à—É–∫
        </button>
        <button class="sec-btn" id="playHereBtn">
          <i data-lucide="play"></i> Play here
        </button>
        <button class="sec-btn" id="copyLinkBtn">
          <i data-lucide="link"></i> Copy link
        </button>
        <button class="sec-btn" id="clearTvBtn">
          <i data-lucide="x"></i> Clear TV
        </button>
      </div>

      <!-- Remote Control -->
      <div class="remote-control" id="remoteControl">
        <div class="remote-header">
          <div class="remote-title">–ü—É–ª—å—Ç TV</div>
          <div class="remote-media" id="remoteMedia">–ù—ñ—á–æ–≥–æ –Ω–µ –≥—Ä–∞—î</div>
        </div>
        <div class="remote-progress">
          <span class="remote-time" id="remoteCurrentTime">00:00</span>
          <div class="remote-seek" id="remoteSeek">
            <div class="remote-seek-fill" id="remoteSeekFill"></div>
          </div>
          <span class="remote-time" id="remoteDuration">00:00</span>
        </div>
        <div class="remote-buttons">
          <button class="remote-btn" id="remoteBack30" title="-30 —Å–µ–∫">
            <i data-lucide="rewind"></i> 30
          </button>
          <button class="remote-btn" id="remoteBack10" title="-10 —Å–µ–∫">
            <i data-lucide="skip-back"></i>
          </button>
          <button
            class="remote-btn remote-play"
            id="remotePlayPause"
            title="Play/Pause"
          >
            <i data-lucide="play" id="remotePlayIcon"></i>
          </button>
          <button class="remote-btn" id="remoteForward10" title="+10 —Å–µ–∫">
            <i data-lucide="skip-forward"></i>
          </button>
          <button class="remote-btn" id="remoteForward30" title="+30 —Å–µ–∫">
            30 <i data-lucide="fast-forward"></i>
          </button>
        </div>
      </div>

      <!-- Status -->
      <div class="status" id="status">Ready</div>

      <!-- Preview -->
      <div class="preview">
        <div class="preview-title">Preview</div>
        <div class="preview-container" id="preview">
          <div class="preview-placeholder">
            <i data-lucide="film"></i>
            <span>No media</span>
          </div>
        </div>
      </div>

      <!-- History -->
      <div class="history" id="historySection">
        <div class="history-header">
          <span class="history-title">Recent</span>
          <button class="history-clear" id="clearHistory">Clear all</button>
        </div>
        <div class="history-list" id="historyList"></div>
      </div>

      <!-- Bookmarklet -->
      <div class="bookmarklet">
        <div class="bookmarklet-title">Bookmarklet</div>
        <a class="bookmarklet-link" id="bookmarklet" href="#">‚Üí Send to TV</a>
        <div class="bookmarklet-hint">
          Drag this to your bookmarks bar. Click it on any page with video.
        </div>
      </div>

      <footer class="footer">
        <span>LAN Video Server</span>
        <span id="serverInfo"></span>
      </footer>
    </div>

    <script>
      lucide.createIcons();

      const $ = (id) => document.getElementById(id);
      const urlInput = $("url");
      const sendBtn = $("sendBtn");
      const detectHint = $("detectHint");
      const detectText = $("detectText");
      const inputIcon = $("inputIcon");
      const status = $("status");
      const preview = $("preview");
      const tvCount = $("tvCount");
      const historyList = $("historyList");
      const dropZone = $("dropZone");
      const searchModal = $("searchModal");
      const searchInput = $("searchInput");
      const searchResultsContainer = $("searchResultsContainer");

      // Server info
      $("serverInfo").textContent = location.host;
      $("tvLink").href = `http://${location.host}/tv.html`;

      // Bookmarklet
      const bookmarkletCode = `javascript:(function(){var s=document.location.href;fetch('http://${location.host}/api/url2hls',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:s})}).then(r=>r.json()).then(d=>{if(d.streamUrl){fetch('http://${location.host}/tv/push',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:d.streamUrl})}).then(()=>alert('Sent to TV: '+d.name)).catch(e=>alert('Error: '+e))}else{fetch('http://${location.host}/tv/push',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:s})}).then(()=>alert('Sent to TV')).catch(e=>alert('Error: '+e))}}).catch(()=>{fetch('http://${location.host}/tv/push',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:s})}).then(()=>alert('Sent to TV'))})})();`;
      $("bookmarklet").href = bookmarkletCode;

      // History management
      function getHistory() {
        try {
          return JSON.parse(localStorage.getItem("lanvideo_history") || "[]");
        } catch {
          return [];
        }
      }
      function saveHistory(items) {
        localStorage.setItem(
          "lanvideo_history",
          JSON.stringify(items.slice(0, 20)),
        );
      }
      function addToHistory(url, title, site, icon) {
        const history = getHistory().filter((h) => h.url !== url);
        history.unshift({
          url,
          title: title || url,
          site: site || "",
          icon: icon || "link",
          time: Date.now(),
        });
        saveHistory(history);
        renderHistory();
      }
      function renderHistory() {
        const history = getHistory();
        if (history.length === 0) {
          $("historySection").style.display = "none";
          return;
        }
        $("historySection").style.display = "block";
        historyList.innerHTML = history
          .map(
            (h, i) => `
        <div class="history-item" data-url="${encodeURIComponent(h.url)}">
          <i data-lucide="${h.icon || "link"}"></i>
          <span class="title">${h.title}</span>
          ${h.site ? `<span class="site">${h.site}</span>` : ""}
          <button class="delete" data-idx="${i}"><i data-lucide="x"></i></button>
        </div>
      `,
          )
          .join("");
        lucide.createIcons();

        historyList.querySelectorAll(".history-item").forEach((el) => {
          el.addEventListener("click", (e) => {
            if (e.target.closest(".delete")) return;
            urlInput.value = decodeURIComponent(el.dataset.url);
            urlInput.dispatchEvent(new Event("input"));
          });
        });
        historyList.querySelectorAll(".delete").forEach((el) => {
          el.addEventListener("click", (e) => {
            e.stopPropagation();
            const history = getHistory();
            history.splice(parseInt(el.dataset.idx), 1);
            saveHistory(history);
            renderHistory();
          });
        });
      }
      $("clearHistory").addEventListener("click", () => {
        saveHistory([]);
        renderHistory();
      });
      renderHistory();

      // TV count polling
      async function updateTvCount() {
        try {
          const r = await fetch("/tv/clients");
          const d = await r.json();
          tvCount.textContent = d.clients || 0;
          tvCount.classList.toggle("zero", d.clients === 0);
        } catch {}
      }
      setInterval(updateTvCount, 3000);
      updateTvCount();

      // URL detection with debounce
      let detectTimeout = null;
      let currentDetection = null;

      urlInput.addEventListener("input", () => {
        const url = urlInput.value.trim();
        clearTimeout(detectTimeout);

        if (!url) {
          sendBtn.disabled = true;
          detectHint.classList.remove("ready");
          detectText.textContent = "Paste a URL to detect type";
          inputIcon.setAttribute("data-lucide", "link");
          lucide.createIcons();
          updatePreview(null);
          return;
        }

        sendBtn.disabled = false;
        detectText.textContent = "Detecting...";

        detectTimeout = setTimeout(async () => {
          try {
            const r = await fetch(`/api/detect?url=${encodeURIComponent(url)}`);
            const d = await r.json();
            currentDetection = d;

            inputIcon.setAttribute("data-lucide", d.icon || "link");
            lucide.createIcons();

            detectHint.classList.add("ready");
            let text = "";
            if (d.site) text = `<span class="site-badge">${d.site}</span> `;
            if (d.title) text += d.title;
            else if (d.type === "torrent") text += "Torrent stream";
            else if (d.type === "video") text += "Direct video";
            else if (d.type === "stream") text += "HLS stream";
            else if (d.type === "youtube") text += "YouTube video";
            else text += "Website";

            detectText.innerHTML = text;
            updatePreview(url, d);
          } catch (e) {
            detectText.textContent = "Unknown URL type";
            currentDetection = { type: "website", method: "iframe" };
          }
        }, 300);
      });

      function updatePreview(url, detection) {
        if (!url) {
          preview.innerHTML =
            '<div class="preview-placeholder"><i data-lucide="film"></i><span>No media</span></div>';
          lucide.createIcons();
          return;
        }

        const lower = url.toLowerCase();

        if (detection?.thumbnail) {
          preview.innerHTML = `<img src="${detection.thumbnail}" alt="thumbnail">`;
        } else if (lower.endsWith(".mp4") || lower.endsWith(".webm")) {
          preview.innerHTML = `<video src="${url}" controls muted></video>`;
        } else if (/youtube|youtu\.be/.test(lower)) {
          const id = url.match(/(?:v=|\/)([0-9A-Za-z_-]{11})/)?.[1];
          if (id)
            preview.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe>`;
        } else if (detection?.type === "torrent") {
          preview.innerHTML =
            '<div class="preview-placeholder"><i data-lucide="download"></i><span>Torrent</span></div>';
          lucide.createIcons();
        } else {
          preview.innerHTML =
            '<div class="preview-placeholder"><i data-lucide="globe"></i><span>Website</span></div>';
          lucide.createIcons();
        }
      }

      // Send to TV
      sendBtn.addEventListener("click", sendToTv);
      urlInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") sendToTv();
      });

      async function sendToTv() {
        const url = urlInput.value.trim();
        if (!url) return;

        status.className = "status";
        status.textContent = "Processing...";

        try {
          let urlToSend = url;
          let title = currentDetection?.title || url;
          let site = currentDetection?.site || "";
          let icon = currentDetection?.icon || "link";

          // For yt-dlp supported sites, create HLS stream
          if (currentDetection?.method === "yt-dlp") {
            status.textContent = "Creating stream via yt-dlp...";
            const r = await fetch("/api/url2hls", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url }),
            });
            const d = await r.json();
            if (d.error) throw new Error(d.error);
            urlToSend = d.streamUrl;
            title = d.name || title;
          }
          // For torrents, use existing torrent2mp4
          // Variables for episode info
          let episodes = null;
          let streamId = null;

          if (
            currentDetection?.type === "torrent" ||
            url.startsWith("magnet:") ||
            url.toLowerCase().endsWith(".torrent")
          ) {
            status.textContent = "Creating torrent stream...";
            const r = await fetch("/api/torrent2mp4", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ url }),
            });
            const d = await r.json();
            if (d.error) throw new Error(d.error);
            urlToSend =
              d.streamUrl || `/hls/${encodeURIComponent(d.streamId)}.m3u8`;
            title = d.name || title;
            icon = "download";

            // Store video files for episode switching
            if (d.videoFiles && d.videoFiles.length > 1) {
              episodes = d.videoFiles;
              streamId = d.streamId;
            }
          }

          // Push to TV with metadata
          status.textContent = "Sending to TV...";
          const pushPayload = { url: urlToSend, name: title };
          if (episodes) {
            pushPayload.episodes = episodes;
            pushPayload.streamId = streamId;
            pushPayload.currentIndex = 0;
          }

          const pushRes = await fetch("/tv/push", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(pushPayload),
          });
          const pushData = await pushRes.json();

          if (pushData.success) {
            status.className = "status success";
            status.textContent = `Sent to ${pushData.clients} TV(s): ${title}`;
            addToHistory(url, title, site, icon);
          } else {
            throw new Error(pushData.error || "Failed to send");
          }
        } catch (e) {
          status.className = "status error";
          status.textContent = "Error: " + e.message;
        }
      }

      // Play here
      $("playHereBtn").addEventListener("click", () => {
        const url = urlInput.value.trim();
        if (url) location.href = `/player.html?url=${encodeURIComponent(url)}`;
      });

      // Copy link
      $("copyLinkBtn").addEventListener("click", async () => {
        const url = urlInput.value.trim();
        if (!url) return;
        const shareUrl = `${location.origin}/player.html?url=${encodeURIComponent(url)}`;
        await navigator.clipboard.writeText(shareUrl);
        status.textContent = "Link copied!";
      });

      // Clear TV
      $("clearTvBtn").addEventListener("click", async () => {
        await fetch("/tv/clear", { method: "POST" });
        status.textContent = "TV cleared";
      });

      // Remote control
      async function sendTvControl(action, value) {
        try {
          await fetch("/tv/control", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ action, value }),
          });
        } catch (err) {
          console.error("Remote control error:", err);
        }
      }

      $("remoteBack30").addEventListener("click", () =>
        sendTvControl("seekRelative", -30),
      );
      $("remoteBack10").addEventListener("click", () =>
        sendTvControl("seekRelative", -10),
      );
      $("remotePlayPause").addEventListener("click", () =>
        sendTvControl("togglePlay"),
      );
      $("remoteForward10").addEventListener("click", () =>
        sendTvControl("seekRelative", 10),
      );
      $("remoteForward30").addEventListener("click", () =>
        sendTvControl("seekRelative", 30),
      );

      // Seek bar click
      const remoteSeek = $("remoteSeek");
      const remoteSeekFill = $("remoteSeekFill");
      const remoteCurrentTime = $("remoteCurrentTime");
      const remoteDuration = $("remoteDuration");
      const remoteMedia = $("remoteMedia");
      const remotePlayIcon = $("remotePlayIcon");

      let currentDuration = 0;

      remoteSeek.addEventListener("click", (e) => {
        if (!currentDuration) return;
        const rect = remoteSeek.getBoundingClientRect();
        const pct = (e.clientX - rect.left) / rect.width;
        const seekTime = pct * currentDuration;
        sendTvControl("seek", seekTime);
      });

      function formatTime(s) {
        if (!s || isNaN(s)) return "00:00";
        const h = Math.floor(s / 3600);
        const m = Math.floor((s % 3600) / 60);
        const sec = Math.floor(s % 60);
        if (h > 0) {
          return `${h}:${m.toString().padStart(2, "0")}:${sec.toString().padStart(2, "0")}`;
        }
        return `${m.toString().padStart(2, "0")}:${sec.toString().padStart(2, "0")}`;
      }

      // SSE for remote state
      function connectRemoteSSE() {
        const evtSource = new EventSource("/tv/remote");

        evtSource.onmessage = (e) => {
          try {
            const state = JSON.parse(e.data);
            currentDuration = state.duration || 0;

            remoteCurrentTime.textContent = formatTime(state.currentTime);
            remoteDuration.textContent = formatTime(state.duration);

            const pct = state.duration
              ? (state.currentTime / state.duration) * 100
              : 0;
            remoteSeekFill.style.width = pct + "%";

            if (state.mediaName) {
              remoteMedia.textContent = state.mediaName;
            } else {
              remoteMedia.textContent = "–ù—ñ—á–æ–≥–æ –Ω–µ –≥—Ä–∞—î";
            }

            remotePlayIcon.setAttribute(
              "data-lucide",
              state.paused ? "play" : "pause",
            );
            lucide.createIcons();
          } catch (err) {
            console.error("Remote SSE error:", err);
          }
        };

        evtSource.onerror = () => {
          evtSource.close();
          setTimeout(connectRemoteSSE, 3000);
        };
      }

      connectRemoteSSE();

      // Search functionality
      let currentSearchSource = "youtube";
      let searchTimeout = null;

      // Open search modal
      $("searchBtn").addEventListener("click", () => {
        searchModal.classList.add("active");
        searchInput.focus();
        lucide.createIcons();
      });

      // Close search modal
      $("closeSearch").addEventListener("click", () => {
        searchModal.classList.remove("active");
      });

      // Close on background click
      searchModal.addEventListener("click", (e) => {
        if (e.target === searchModal) {
          searchModal.classList.remove("active");
        }
      });

      // Close on Escape
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && searchModal.classList.contains("active")) {
          searchModal.classList.remove("active");
        }
      });

      // Tab switching
      document.querySelectorAll(".modal-tab").forEach((tab) => {
        tab.addEventListener("click", () => {
          document
            .querySelectorAll(".modal-tab")
            .forEach((t) => t.classList.remove("active"));
          tab.classList.add("active");
          currentSearchSource = tab.dataset.source;

          // Re-search with new source if there's a query
          if (searchInput.value.trim()) {
            performSearch(searchInput.value.trim());
          }
        });
      });

      // Search input handler with debounce
      searchInput.addEventListener("input", () => {
        const query = searchInput.value.trim();
        clearTimeout(searchTimeout);

        if (!query) {
          searchResultsContainer.innerHTML =
            '<div class="search-empty">–í–≤–µ–¥—ñ—Ç—å –∑–∞–ø–∏—Ç –¥–ª—è –ø–æ—à—É–∫—É</div>';
          return;
        }

        searchResultsContainer.innerHTML =
          '<div class="search-loading">–®—É–∫–∞—î–º–æ...</div>';

        searchTimeout = setTimeout(() => {
          performSearch(query);
        }, 500);
      });

      // Search on Enter
      searchInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          clearTimeout(searchTimeout);
          const query = searchInput.value.trim();
          if (query) performSearch(query);
        }
      });

      // Perform search
      async function performSearch(query) {
        try {
          const endpoint =
            currentSearchSource === "youtube"
              ? `/api/search/youtube?q=${encodeURIComponent(query)}`
              : `/api/search/torrents?q=${encodeURIComponent(query)}`;

          const response = await fetch(endpoint);
          const data = await response.json();

          if (data.error) {
            searchResultsContainer.innerHTML = `<div class="search-empty">–ü–æ–º–∏–ª–∫–∞: ${data.error}</div>`;
            return;
          }

          if (!data.results || data.results.length === 0) {
            searchResultsContainer.innerHTML =
              '<div class="search-empty">–ù—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ</div>';
            return;
          }

          // Render results
          renderSearchResults(data.results);
        } catch (err) {
          searchResultsContainer.innerHTML = `<div class="search-empty">–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É: ${err.message}</div>`;
        }
      }

      // Render search results
      function renderSearchResults(results) {
        const html = results
          .map((r) => {
            let meta = "";

            // YouTube metadata
            if (currentSearchSource === "youtube") {
              const duration = r.duration ? formatDuration(r.duration) : "";
              const views = r.views ? formatViews(r.views) : "";
              meta = [r.channel, views, duration].filter(Boolean).join(" ‚Ä¢ ");
            }
            // Torrent metadata
            else {
              const parts = [];
              if (r.source) parts.push(`üì¶ ${r.source}`);
              if (r.size) parts.push(`üíæ ${r.size}`);
              if (r.seeders !== undefined) {
                const seedColor =
                  r.seeders > 50 ? "üü¢" : r.seeders > 10 ? "üü°" : "üî¥";
                parts.push(`${seedColor} ${r.seeders} seeders`);
              }
              if (r.rating) parts.push(`‚≠ê ${r.rating}`);
              meta = parts.join(" ‚Ä¢ ");
            }

            const url = r.url || r.magnetLink || "";
            const thumbContent = r.thumbnail
              ? `<img src="${r.thumbnail}" alt="${r.title}">`
              : '<div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:var(--gray-600);font-size:34px;">üé¨</div>';

            return `
            <div class="search-result" data-url="${encodeURIComponent(url)}">
              <div class="search-result-thumb">
                ${thumbContent}
              </div>
              <div class="search-result-info">
                <div class="search-result-title">${escapeHtml(r.title)}</div>
                ${meta ? `<div class="search-result-meta">${meta}</div>` : ""}
              </div>
            </div>
          `;
          })
          .join("");

        searchResultsContainer.innerHTML = `<div class="search-results">${html}</div>`;

        // Add click handlers
        searchResultsContainer
          .querySelectorAll(".search-result")
          .forEach((el) => {
            el.addEventListener("click", () => {
              const url = decodeURIComponent(el.dataset.url);
              urlInput.value = url;
              urlInput.dispatchEvent(new Event("input"));
              searchModal.classList.remove("active");
            });
          });
      }

      // Helper: format duration
      function formatDuration(seconds) {
        if (!seconds) return "";
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        if (h > 0)
          return `${h}:${String(m).padStart(2, "0")}:${String(s).padStart(2, "0")}`;
        return `${m}:${String(s).padStart(2, "0")}`;
      }

      // Helper: format views
      function formatViews(views) {
        if (!views) return "";
        if (views >= 1000000) return `${(views / 1000000).toFixed(1)}M views`;
        if (views >= 1000) return `${(views / 1000).toFixed(1)}K views`;
        return `${views} views`;
      }

      // Helper: escape HTML
      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Drag & drop for torrent files
      document.addEventListener("dragenter", (e) => {
        e.preventDefault();
        if (e.dataTransfer.types.includes("Files")) {
          dropZone.classList.add("active");
        }
      });
      dropZone.addEventListener("dragleave", (e) => {
        if (e.target === dropZone) dropZone.classList.remove("active");
      });
      dropZone.addEventListener("dragover", (e) => e.preventDefault());
      dropZone.addEventListener("drop", async (e) => {
        e.preventDefault();
        dropZone.classList.remove("active");

        const file = e.dataTransfer.files[0];
        if (!file || !file.name.endsWith(".torrent")) {
          status.textContent = "Only .torrent files supported";
          return;
        }

        status.textContent = "Uploading torrent...";

        // Read file and convert to base64 data URI for processing
        const reader = new FileReader();
        reader.onload = async () => {
          // For now, we can't directly upload - user needs to use magnet or URL
          // Show file name and suggest using magnet link
          status.textContent = `Torrent: ${file.name} - Please use magnet link or torrent URL instead`;
        };
        reader.readAsDataURL(file);
      });
    </script>
  </body>
</html>
